---
title: "HDNAextractions_analysis"
author: "Mary Grace Catapang"
date: '2022-06-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
library("tidyverse")
library(dplyr)
library(ggplot2)
library(dplyr)
library(viridis)
library(ggpubr)
library(ggdark)
```

## Data Import

```{r col types}
col_dna <- cols (
  label = col_character(),
  catalog_number = col_character(),
  country = col_character(),
  year_collected = col_date(format = "%Y"),
  dna_extraction = col_character(),
  date_extracted = col_date("%d%b%y"),#tofix parsing error
  extracted_by = col_character(),
  overnight_incubation = col_character(),
  mass_g = col_double(),
  qubit = col_character(),
  concentration = col_double()
)
```

```{r concentration data}
HDNA_data <- read_csv("./data/hDNA_extraction_NHRE_datafinal.csv", col_types = col_dna)
```

```{r purity data}
NanoDrop_data <- read_csv("./data/NanoDrop1_transformed.csv", col_types = col_dna)
```

## Plots Initial

This is just for data exploration and won't be going into the poster. 

### Specimens
```{r country of origin}
ggplot(data = HDNA_data) + 
  geom_bar(mapping = aes(x = country, fill = contemporary)) +
  coord_flip()
```

```{r year of collection}
ggplot(data = HDNA_data) + 
  geom_bar(mapping = aes(x = year_collected, fill = country))
```

### Mass vs. Concentration

```{r mass vs. concentration by country}
ggplot(HDNA_data, aes(x=mass_g, y=concentration_norm, color=country)) +
  geom_point(size=2)
```

```{r mass vs. concentration by year}
ggplot(HDNA_data, aes(x=mass_g, y=concentration_norm, color=year_collected)) +
  geom_point(size=2)
```

### Year vs. Concentration

```{r year vs. concentration scatterplot}
ggplot(HDNA_data, aes(x=year_collected, y=concentration_norm, color=country)) + 
    geom_point(size=2)
```

## Map

A map showing the location of the specimens used for the analysis.

```{r world map}
# world map, not clean
WorldMap <- map_data("world") %>%
               filter(region != "Antarctica") %>%
               fortify
```

```{r centroid for bubbles}
centroid <- read_csv("./data/centroid.csv")
```

```{r specimen data}
# set data types
cols_country <- cols(
  `Country` = col_character(),
  `longitude` = col_double(),
  `latitude` = col_double(),
  `ISO` = col_character(),
  `COUNTRYAFF` = col_character(),
  `AFF_ISO` = col_character(),
  `count_specimens` = col_integer()
)

# add geospatial data to specimen data
df1 <- HDNA_data %>% filter(contemporary == "no") %>%
  group_by(country) %>% summarise(count_specimens = n())

data_geo_country <- distinct(merge(centroid, df1, by = "country", all.y=TRUE, col_types = cols_country))

```

This map still requires fixing for aesthetics. Centroid data should also be modified to included places like Hawaii and Galapagos. It might be good to have a map centered in the Pacific?

```{r plotting map customized}
# Create breaks for the color scale
mybreaks <- c(1, 3, 11)

ggplot() +
  geom_polygon(data = WorldMap, aes(x=long, y = lat, group = group), fill="gray", color = "white", alpha=0.9) +
  geom_point( data=data_geo_country, aes(x=long, y=lat, size=count_specimens, color=count_specimens, alpha = count_specimens))+
  scale_size_continuous(name="Number of Specimens", trans="log", range=c(3,10), breaks=mybreaks) +
    scale_alpha_continuous(name="Number of Specimens", trans="log", range=c(0.1, .9), breaks=mybreaks) +
    scale_color_distiller(palette = "YlOrBr", trans="log", breaks=mybreaks,name="Number of Specimens" ) +
  theme_void() +
  guides( colour = guide_legend()) + 
  dark_theme_gray() +
  theme(
    plot.background = element_rect(fill = "grey10"),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.background = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank(),
    legend.position="bottom"
    )
```

## Correlation with specimen age

There is no correlation between age of specimen and the DNA concentration collected.

```{r year vs. concentration scatterplot}
# linear trend + confidence interval
sp1 <- ggplot(HDNA_data, aes(x=year_collected, y=concentration_norm, color = dna_extraction)) +
  geom_point() +
  geom_smooth(method=lm , color="#b77984", fill="#69b3a2", se=TRUE) +
  labs(x = "year collected", y="concentration(ng/μL/g)") +
  scale_color_manual(values=c("#dccc77",
                               "#88cdee",
                               "#b77984"
                             )) +
  dark_theme_gray() +
  theme(
    plot.background = element_rect(fill = "grey10"),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    panel.grid.major = element_line(color = "grey30", size = 0.2),
    panel.grid.minor = element_line(color = "grey30", size = 0.2),
    legend.key = element_blank(),
    legend.background = element_blank(),
    legend.position="bottom",
    legend.title = element_blank()
  )
sp1 + stat_cor(method = "pearson", label.x = 50, label.y = 150, color = "white")
```
```{r year vs. purity scatterplot}
ggplot(NanoDrop_data, aes(x=year_collected, y= "260/230")) +
  geom_point(color = "black") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE)
```

## Statistical Analysis

I used t-test to identify whether there is a significant difference between the qubit concentration of the DNA extracted using different methods. A p-value of ≤ 0.05 is considered statistically signficant.

```{r data import}
#filter data, historical specimens per extraction method
BloodTissue <- filter(HDNA_data, contemporary == "no", dna_extraction == "Qiagen BT" )
Autogen <- filter(HDNA_data, contemporary == "no", dna_extraction == "Autogen GP" )
PowerSoil <- filter(HDNA_data, contemporary == "no", dna_extraction == "Qiagen PP" )
```

No significant statistical difference between Blood&Tissue and Autogen.

```{r t-test BloodTissue vs. Autogen}

t.test(BloodTissue$concentration_norm, Autogen$concentration_norm) 
```

There is significant statistical difference between Powersoil and Autogen.

```{r t-test PowerSoil vs. Autogen}

t.test(PowerSoil$concentration_norm, Autogen$concentration_norm) 
```

There is significant statistical difference between Blood&Tissue and Powersoil.

```{r t-test PowerSoil vs. BloodTissue}

t.test(PowerSoil$concentration_norm, BloodTissue$concentration_norm) 
```

## Boxplot
This plot still needs cleaning and editing to match poster aesthetics.
```{r box plot concentration}
hDNA_extract <- filter(HDNA_data, contemporary == "no")
ggplot(hDNA_extract, aes(x=as.factor(dna_extraction), y=concentration_norm, fill = dna_extraction)) + 
  geom_boxplot(color="white", alpha=0.9) +
  scale_fill_manual(values=c("#dccc77",
                               "#88cdee",
                               "#b77984"
                             )) +
  xlab("DNA extraction") +
  ylab("concentration(ng/μL/g)") +
  dark_theme_gray() +
  theme(
    plot.background = element_rect(fill = "grey10"),
    panel.background = element_blank(),
    panel.grid.major = element_line(color = "grey30", size = 0.2),
    panel.grid.minor = element_line(color = "grey30", size = 0.2),
    legend.background = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none"
  )
```
```{r box plot purity contemporary vs. historical}
ggplot(NanoDrop_data, aes(x=as.factor(contemporary), y="260/230 ratio")) + 
    geom_boxplot(color = "black", fill="slateblue", alpha=0.9) + 
    xlab("Contemporary")
```
```{r box plot purity by DNA}
ggplot(NanoDrop_data, aes(x=as.factor(dna_extraction), y="260/230 ratio")) + 
    geom_boxplot(color = "black", fill="slateblue", alpha=0.9) + 
    xlab("DNA extraction")
```
## Nanodrop and Qubit correlation
```{r nanodrop vs. qubit concentration scatterplot}
# linear trend + confidence interval
sp3 <- ggplot(NanoDrop_data, aes(x=nanodrop_concentration, y=concentration)) +
  geom_point(color = "black") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) 
sp3 + stat_cor(method = "pearson", label.x = 100, label.y = 100, color = "black")
```